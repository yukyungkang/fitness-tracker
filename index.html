<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3개월 다이어트 플랜</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Helvetica', sans-serif; margin: 0; background: #fff; color: #000; }
header { background: #000; color: #fff; text-align: center; padding: 15px; }
header button { margin: 10px; padding: 8px; }
nav { display: flex; justify-content: center; background: #eee; }
nav button { flex: 1; padding: 12px; border: none; cursor: pointer; }
nav button.active { background: #000; color: #fff; }
section { display: none; padding: 20px; max-width: 900px; margin: auto; }
section.active { display: block; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
th { background: #000; color: #fff; }
canvas { width: 100%; max-height: 300px; margin-top: 20px; }
.list { margin-top: 10px; }
.list-item { padding: 8px; border-bottom: 1px solid #ddd; }
@media(max-width:768px){
  nav button{font-size:14px;}
  table,thead,tbody,th,td,tr{display:block;width:100%;}
  th{display:none;}
  td{padding:10px;border:none;border-bottom:1px solid #ccc;}
  td::before{content:attr(data-label);font-weight:bold;display:block;}
}
</style>
</head>
<body>

<header>
  <h1>3개월 다이어트 관리</h1>
  <div>
    <button id="loginBtn">Google 로그인</button>
    <button id="logoutBtn" style="display:none;">로그아웃</button>
  </div>
  <p id="userInfo"></p>
</header>

<nav>
  <button class="tab-btn active" data-tab="plan">플랜</button>
  <button class="tab-btn" data-tab="weight">체중 기록</button>
  <button class="tab-btn" data-tab="stats">통계</button>
</nav>

<!-- 플랜 -->
<section id="plan" class="active">
  <h2>84일 다이어트 플랜</h2>
  <table>
    <thead>
      <tr>
        <th>Day</th><th>날짜</th><th>주기</th><th>아침 유산소</th><th>저녁 홈트</th><th>완료</th>
      </tr>
    </thead>
    <tbody id="planTable"></tbody>
  </table>
</section>

<!-- 체중 기록 -->
<section id="weight">
  <h2>체중 기록</h2>
  <input type="date" id="dateInput">
  <input type="number" id="weightInput" placeholder="체중 (kg)">
  <button id="addWeightBtn">추가</button>
  <div class="list" id="weightList"></div>
  <table>
    <thead><tr><th>날짜</th><th>체중</th></tr></thead>
    <tbody id="weightTable"></tbody>
  </table>
</section>

<!-- 통계 -->
<section id="stats">
  <h2>체중 변화 그래프</h2>
  <canvas id="weightChart"></canvas>
</section>

<script type="module">
// Firebase SDK
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBasJig37TExc76J3mlcJ9p5uZLXFrY5CQ",
  authDomain: "dietpage-5f49a.firebaseapp.com",
  projectId: "dietpage-5f49a",
  storageBucket: "dietpage-5f49a.firebasestorage.app",
  messagingSenderId: "666434272009",
  appId: "1:666434272009:web:a491c168ac072658bdb1d8",
  measurementId: "G-60RQ5NPWF5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// DOM
const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const userInfo=document.getElementById('userInfo');
const planTable=document.getElementById('planTable');
const weightList=document.getElementById('weightList');
const weightTable=document.getElementById('weightTable');
let currentUser=null;

// Tabs
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// 로그인
loginBtn.onclick=async()=>{
  try{
    const res=await signInWithPopup(auth,provider);
    currentUser=res.user;
    userInfo.textContent=`로그인: ${currentUser.displayName}`;
    loginBtn.style.display='none';logoutBtn.style.display='inline';
    loadPlan();loadWeights();
  }catch(e){console.error(e);}
};
logoutBtn.onclick=async()=>{
  await signOut(auth);
  currentUser=null;
  userInfo.textContent='';
  loginBtn.style.display='inline';logoutBtn.style.display='none';
  planTable.innerHTML='';weightList.innerHTML='';weightTable.innerHTML='';
  chart.data.labels=[];chart.data.datasets[0].data=[];chart.update();
};

// ✅ 84일 플랜 생성
const planData=[];
const startDate=new Date("2024-07-22");
for(let i=0;i<84;i++){
  const d=new Date(startDate);
  d.setDate(d.getDate()+i);
  const dateStr=`${d.getMonth()+1}/${d.getDate()} (${['일','월','화','수','목','금','토'][d.getDay()]})`;
  planData.push({day:i+1,date:dateStr,cycle:"다이어트",morning:"경사6%,속도4.5,30분",evening:"IMPT루틴",link:"https://www.youtube.com/watch?v=wmSz8C44ldo"});
}

// ✅ 플랜 렌더링
async function loadPlan(){
  planTable.innerHTML='';
  const userDoc=doc(db,"plans",currentUser.uid);
  const snap=await getDoc(userDoc);
  let doneData=snap.exists()?snap.data().done:[];
  planData.forEach(item=>{
    const checked=doneData.includes(item.day)?"checked":"";
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${item.day}</td><td>${item.date}</td><td>${item.cycle}</td>
    <td>${item.morning}</td><td><a href="${item.link}" target="_blank">${item.evening}</a></td>
    <td><input type="checkbox" ${checked} data-day="${item.day}"></td>`;
    planTable.appendChild(tr);
  });
  planTable.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change',async()=>{
      const checkedDays=[...planTable.querySelectorAll('input:checked')].map(c=>parseInt(c.dataset.day));
      await setDoc(userDoc,{done:checkedDays});
    });
  });
}

// ✅ 체중 기록 기능
document.getElementById('addWeightBtn').onclick=async()=>{
  const date=document.getElementById('dateInput').value;
  const weight=parseFloat(document.getElementById('weightInput').value);
  if(!date||isNaN(weight)||!currentUser)return alert("입력 또는 로그인 확인!");
  const ref=doc(db,"weights",currentUser.uid);
  const snap=await getDoc(ref);
  let data=snap.exists()?snap.data().records:[];
  data.push({date,weight});
  await setDoc(ref,{records:data});
  renderWeights(data);
};

async function loadWeights(){
  const ref=doc(db,"weights",currentUser.uid);
  const snap=await getDoc(ref);
  if(snap.exists()) renderWeights(snap.data().records);
}

function renderWeights(data){
  data.sort((a,b)=>new Date(a.date)-new Date(b.date));
  weightList.innerHTML=data.map(d=>`<div class="list-item">${d.date} - ${d.weight}kg</div>`).join('');
  weightTable.innerHTML=data.map(d=>`<tr><td>${d.date}</td><td>${d.weight}</td></tr>`).join('');
  chart.data.labels=data.map(d=>d.date);
  chart.data.datasets[0].data=data.map(d=>d.weight);
  chart.update();
}

// ✅ Chart.js
const ctx=document.getElementById('weightChart').getContext('2d');
const chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'체중 (kg)',data:[],borderColor:'#000'}]},options:{responsive:true}});
</script>
</body>
</html>
